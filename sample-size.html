<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sample Size & Wearable Data Confidence</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f5f7fa;
    color: #2c3e50;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 1400px;
    margin: 0 auto;
  }
  h1 { 
    font-size: 1.6em; 
    margin-bottom: 0.3em;
    color: #1a1a1a;
  }
  .subtitle {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 30px;
  }
  
  .dashboard {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  
  .card-header {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .badge {
    font-size: 0.75em;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
  }
  .badge.low { background: #fff3cd; color: #856404; }
  .badge.medium { background: #d1ecf1; color: #0c5460; }
  .badge.high { background: #d4edda; color: #155724; }
  
  #riskChart {
    height: 300px;
    position: relative;
    margin-bottom: 20px;
  }
  
  canvas {
    width: 100%;
    height: 100%;
  }
  
  .controls {
    margin: 20px 0;
  }
  
  .slider-container {
    margin: 15px 0;
  }
  
  .slider-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: #666;
    margin-bottom: 8px;
  }
  
  input[type=range] {
    width: 100%;
  }
  
  .prediction-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    margin: 20px 0;
  }
  
  .risk-score {
    font-size: 3.5em;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .confidence-range {
    font-size: 1.2em;
    opacity: 0.9;
  }
  
  .reliability-indicator {
    margin-top: 15px;
    padding: 12px;
    background: rgba(255,255,255,0.2);
    border-radius: 8px;
    font-size: 0.95em;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 20px;
  }
  
  .metric-box {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
  }
  
  .metric-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #2c3e50;
  }
  
  .metric-label {
    font-size: 0.85em;
    color: #666;
    margin-top: 5px;
  }
  
  .data-table {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
  }
  
  thead {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
  }
  
  th {
    text-align: left;
    padding: 10px 8px;
    background: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    font-size: 0.9em;
  }
  
  td {
    padding: 10px 8px;
    border-bottom: 1px solid #e9ecef;
  }
  
  tr.included {
    background: #e8f5e9;
  }
  
  tr.not-included {
    background: #f8f9fa;
    opacity: 0.4;
  }
  
  .value-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
  }
  .value-badge.good { background: #d4edda; color: #155724; }
  .value-badge.warning { background: #fff3cd; color: #856404; }
  .value-badge.bad { background: #f8d7da; color: #721c24; }
  
  .recommendation-card {
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    border-left: 5px solid;
  }
  .recommendation-card.low {
    background: #fff3cd;
    border-color: #ffc107;
    color: #856404;
  }
  .recommendation-card.medium {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
  }
  .recommendation-card.high {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
  }
  
  .recommendation-card h4 {
    margin: 0 0 10px 0;
    font-size: 1.05em;
  }
  
  .recommendation-card ul {
    margin: 10px 0;
    padding-left: 20px;
    line-height: 1.7;
  }
  
  .biomarkers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 20px;
  }
  
  .biomarker {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9em;
  }
  
  .biomarker-label {
    color: #666;
    font-size: 0.85em;
    margin-bottom: 5px;
  }
  
  .biomarker-value {
    font-size: 1.4em;
    font-weight: 600;
    color: #2c3e50;
  }

  .back-button {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 20px;
    background: #2c3e50;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 0.9em;
    font-weight: 500;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .back-button:hover {
    background: #1a252f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* Collapsible Section Styling */
  .collapsible-section {
    margin: 50px 0;
  }

  .collapsible-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 18px 24px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 12px;
    font-size: 1em;
    font-weight: 600;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
  }
  .collapsible-toggle:hover {
    border-color: #667eea;
    color: #667eea;
    background: #f8f9fa;
  }

  .collapsible-arrow {
    font-size: 1.2em;
    transition: transform 0.3s;
    color: #667eea;
  }
  .collapsible-arrow.open {
    transform: rotate(90deg);
  }

  .collapsible-content {
    display: none;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 40px;
    margin-top: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .collapsible-content.visible {
    display: block;
  }

  .deep-dive-content h3 {
    color: #2c3e50;
    margin-top: 30px;
    margin-bottom: 15px;
    font-size: 1.1em;
  }
  .deep-dive-content p {
    margin-bottom: 1.2em;
    color: #495057;
    line-height: 1.8;
  }
  .deep-dive-content ul {
    padding-left: 25px;
    margin-bottom: 1.2em;
    line-height: 1.7;
  }
  .deep-dive-content li {
    margin-bottom: 8px;
  }

  .key-takeaway {
    background: #e8f5e9;
    padding: 20px 25px;
    border-left: 5px solid #28a745;
    border-radius: 8px;
    margin-top: 30px;
  }

  .prompt-text {
    color: #495057;
    font-size: 0.95em;
    line-height: 1.8;
  }
</style>
</head>
<body>

<div class="container">
  <a href="index.html" class="back-button">‚Üê Back to Home</a>
  <h1>üìä Wearable Sleep Disorder Risk - Sample Size & Confidence</h1>
  <div class="subtitle">
    <strong>What this teaches:</strong> The fundamental statistical principle that more data points lead to narrower confidence intervals and more reliable predictions‚Äîvisualized through wearable health data collection over 90 nights.<br>
    <strong>Why it matters for healthcare:</strong> Answers the critical question: "How many days of smartwatch data do I need before I can trust this health prediction?" A single night shows wild variance; 30+ nights reveal the true signal.
  </div>
  
  <div class="dashboard">
    <div class="card">
      <div class="card-header">
        Risk Score Confidence Over Time
        <span class="badge low" id="reliabilityBadge">Low Reliability</span>
      </div>
      
      <canvas id="riskChart"></canvas>
      
      <div class="controls">
        <div class="slider-container">
          <div class="slider-label">
            <span>Day 1</span>
            <span><strong id="currentDay">7</strong> days of data collected</span>
            <span>Day 90</span>
          </div>
          <input type="range" id="daysSlider" min="1" max="90" step="1" value="7">
        </div>
      </div>
      
      <div class="prediction-box">
        <div style="font-size: 0.9em; opacity: 0.9;">Sleep Apnea Risk Score</div>
        <div class="risk-score" id="riskScore">6.4</div>
        <div class="confidence-range" id="confidenceRange">95% CI: 3.2 - 9.6</div>
        <div class="reliability-indicator" id="reliabilityText">
          ‚ö†Ô∏è High uncertainty - more data needed for reliable prediction
        </div>
      </div>
      
      <div class="metrics-grid">
        <div class="metric-box">
          <div class="metric-value" id="ciWidth">¬±3.2</div>
          <div class="metric-label">Confidence Interval Width</div>
        </div>
        <div class="metric-box">
          <div class="metric-value" id="dataPoints">7</div>
          <div class="metric-label">Nights Recorded</div>
        </div>
        <div class="metric-box">
          <div class="metric-value" id="avgHRV">--</div>
          <div class="metric-label">Avg HRV (ms)</div>
        </div>
        <div class="metric-box">
          <div class="metric-value" id="avgSpO2">--</div>
          <div class="metric-label">Avg SpO2 Drops/hr</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">Current Biomarker Averages</div>
      
      <div class="biomarkers">
        <div class="biomarker">
          <div class="biomarker-label">Resting Heart Rate</div>
          <div class="biomarker-value" id="avgHR">--</div>
        </div>
        <div class="biomarker">
          <div class="biomarker-label">Heart Rate Variability</div>
          <div class="biomarker-value" id="avgHRVBio">--</div>
        </div>
        <div class="biomarker">
          <div class="biomarker-label">SpO2 Drops/hour</div>
          <div class="biomarker-value" id="avgSpO2Bio">--</div>
        </div>
        <div class="biomarker">
          <div class="biomarker-label">Body Temperature</div>
          <div class="biomarker-value" id="avgTemp">--</div>
        </div>
        <div class="biomarker">
          <div class="biomarker-label">Movement Index</div>
          <div class="biomarker-value" id="avgMovement">--</div>
        </div>
        <div class="biomarker">
          <div class="biomarker-label">Sleep Efficiency</div>
          <div class="biomarker-value" id="avgEfficiency">--</div>
        </div>
      </div>
      
      <div class="recommendation-card low" id="recommendationCard">
        <h4>üìã Clinical Recommendations</h4>
        <ul id="recommendationList">
          <li>Continue wearing device nightly</li>
          <li>Minimum 14 days needed for moderate confidence</li>
          <li>30+ days recommended for clinical decisions</li>
        </ul>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      Nightly Wearable Data
      <span style="font-size: 0.85em; font-weight: normal; color: #666;">
        Showing <span id="includedCount">7</span> of 90 nights
      </span>
    </div>
    
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>HR (bpm)</th>
            <th>HRV (ms)</th>
            <th>SpO2 Drops</th>
            <th>Temp (¬∞C)</th>
            <th>Movement</th>
            <th>Sleep Eff.</th>
            <th>Risk Signal</th>
          </tr>
        </thead>
        <tbody id="dataTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- COLLAPSIBLE: TECHNICAL DEEP DIVE -->
  <div class="collapsible-section">
    <button class="collapsible-toggle" onclick="toggleDeepDive()">
      <span>üìö Technical Deep Dive: Sample Size & Statistical Confidence</span>
      <span class="collapsible-arrow" id="deepDiveArrow">‚Ä∫</span>
    </button>

    <div class="collapsible-content deep-dive-content" id="deepDiveContent">
      <h3 style="color: #2c3e50; margin-top: 20px;">The Central Limit Theorem in Action</h3>
      <p>
        This demo visualizes the <strong>Central Limit Theorem (CLT)</strong>‚Äîone of statistics' most important principles. The CLT states that as sample size increases, the distribution of sample means approaches a normal distribution, and the <strong>standard error</strong> (uncertainty in our estimate) decreases proportional to the square root of sample size.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">The Math: Why Confidence Shrinks with ‚àön</h3>
      <p>
        The <strong>standard error (SE)</strong> of the mean is:
      </p>
      <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; text-align: center;">
        SE = œÉ / ‚àön
      </p>
      <p style="margin-top: 10px;">
        Where œÉ is the population standard deviation and n is sample size. The 95% <strong>confidence interval</strong> is approximately:
      </p>
      <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; text-align: center;">
        CI = mean ¬± 1.96 √ó SE = mean ¬± 1.96 √ó (œÉ / ‚àön)
      </p>
      <p style="margin-top: 10px;">
        In this demo, the baseline CI at 7 days is ¬±3.2. Watch what happens:
      </p>
      <ul style="padding-left: 25px;">
        <li><strong>7 days:</strong> CI = ¬±3.2 (risk score: 3.2 to 9.6) ‚Äî too wide for clinical decisions</li>
        <li><strong>14 days:</strong> CI = ¬±2.3 (risk score: 4.1 to 8.7) ‚Äî 28% narrower (‚àö14/‚àö7 ‚âà 1.41)</li>
        <li><strong>30 days:</strong> CI = ¬±1.5 (risk score: 4.9 to 7.9) ‚Äî clinically useful</li>
        <li><strong>90 days:</strong> CI = ¬±0.9 (risk score: 5.5 to 7.3) ‚Äî high precision</li>
      </ul>
      <p>
        Notice: <strong>doubling sample size doesn't halve uncertainty‚Äîyou need 4√ó the data to halve the CI</strong> (because ‚àö4 = 2). This is why 90 days of data is dramatically better than 7 days, but 180 days only marginally improves on 90.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">Why This Matters for Wearable Diagnostics</h3>
      <p>
        Consumer wearables collect <strong>noisy data</strong>: heart rate varies with stress, HRV fluctuates with sleep quality, SpO2 drops depend on sleep position. Any single night's data is unreliable. But averaged over many nights, the true signal emerges from the noise.
      </p>
      <p>
        <strong>Example:</strong> This patient's true sleep apnea risk is 6.4/10. On day 1, you might see a risk estimate anywhere from 3 to 10 (noise dominates). By day 30, the estimate stabilizes near 6.4 ¬± 1.5‚Äîenough precision to guide treatment decisions.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">Clinical Decision Thresholds</h3>
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
        <p style="margin: 0;"><strong style="color: #856404;">Low Reliability (&lt;14 days):</strong> CI too wide. Risk score of 6.4 ¬± 3.2 means true value could be anywhere from 3.2 (low risk, no treatment) to 9.6 (high risk, urgent treatment). <strong>Cannot safely make clinical decisions.</strong></p>
        <p style="margin: 15px 0 0 0;"><strong style="color: #0c5460;">Moderate Reliability (14-29 days):</strong> CI narrowing to ¬±1.5-2.3. Can begin discussing findings with patient, but recommend more data before starting treatment. Good for monitoring trends.</p>
        <p style="margin: 15px 0 0 0;"><strong style="color: #155724;">High Reliability (30+ days):</strong> CI narrow (¬±0.9-1.5). The true risk score is well-constrained. Safe to use for clinical decisions like CPAP referral or medication adjustments.</p>
      </div>

      <h3 style="color: #2c3e50; margin-top: 25px;">The Trade-off: Precision vs Time</h3>
      <p>
        Healthcare faces a fundamental tension: <strong>faster decisions vs more accurate decisions</strong>. This demo shows the cost of speed:
      </p>
      <ul style="padding-left: 25px;">
        <li>Decide at 7 days: Fast, but 50% chance your decision is based on noise rather than signal</li>
        <li>Wait 30 days: Slower, but 95% confidence your decision reflects true patient risk</li>
        <li>Wait 90 days: Marginal improvement in precision, but patient waits 3 months for diagnosis</li>
      </ul>
      <p>
        <strong>Clinical guideline recommendation:</strong> Minimum 14 days for screening, 30+ days for treatment decisions. This balances precision with patient care timeliness.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">How This Demo Simulates Realistic Data</h3>
      <p>
        The 90 nights of data include:
      </p>
      <ul style="padding-left: 25px;">
        <li><strong>Individual variation:</strong> Each night's HR, HRV, SpO2 drops vary randomly (simulating real biological noise)</li>
        <li><strong>Weekend effect:</strong> SpO2 drops are 1.5 events/hour higher on weekends (alcohol consumption, later bedtimes)</li>
        <li><strong>True underlying signal:</strong> Patient's actual risk is 6.4/10, which becomes apparent only after averaging many nights</li>
      </ul>
      <p>
        Try moving the slider: early days show wild swings in the estimated risk, but by day 30, the estimate converges to the true value. This is the CLT in action‚Äî<strong>random noise cancels out with sufficient data</strong>.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">Real-World Application: Apple Heart Study</h3>
      <p>
        The Apple Heart Study (n=419,297) used Apple Watch PPG sensors to detect atrial fibrillation. Their protocol required <strong>5+ irregular pulse notifications over 120 days</strong> before alerting users, precisely to avoid false alarms from single noisy measurements. This demo teaches the same principle they applied: one-night measurements are unreliable; month-long averages are actionable.
      </p>

      <h3 style="color: #2c3e50; margin-top: 25px;">Connection to AI Model Performance</h3>
      <p>
        This concept applies to AI training too: models trained on 100 samples have high variance (overfitting risk); models trained on 10,000 samples generalize better. The same ‚àön relationship governs both <strong>measurement confidence</strong> (this demo) and <strong>model performance confidence</strong>.
      </p>

      <div class="key-takeaway">
        <strong>Key Takeaway:</strong> More data = narrower confidence intervals = safer clinical decisions. When deploying wearable-based diagnostics, always specify the minimum data collection period required for reliable predictions. This demo proves that 7 days is insufficient, 30+ days is recommended, and 90 days provides high precision‚Äîbut diminishing returns suggest 30-60 days is the practical sweet spot.
      </div>
    </div>
  </div>

  <!-- COLLAPSIBLE: VIEW PROMPT -->
  <div class="collapsible-section">
    <button class="collapsible-toggle" onclick="togglePrompt()">
      <span>üìã View Prompt Used to Generate This Demo</span>
      <span class="collapsible-arrow" id="promptArrow">‚Ä∫</span>
    </button>

    <div class="collapsible-content" id="promptContent">
      <div class="prompt-text">
        "Create an interactive website (HTML file only) to teach the concept of <strong>sample size and statistical confidence</strong> in wearable health diagnostics. The tool should teach learners that prediction confidence increases (uncertainty decreases) as more data is collected, following the Central Limit Theorem.
        <br><br>
        The tool should simulate a patient wearing an Oura Ring for sleep apnea risk assessment over 90 nights. Learners should move a slider from day 1 to day 90 and observe how the 95% confidence interval around the risk score narrows from ¬±3.2 (very wide/unreliable at 7 days) to ¬±0.9 (narrow/reliable at 90 days), following the ‚àön relationship (confidence interval shrinks proportional to the square root of sample size).
        <br><br>
        The visualization should show a risk score chart over time with a shaded confidence band that narrows as more data accumulates. Display the current risk score (6.4/10) with its confidence interval prominently. Show reliability badges (Low/Moderate/High) based on data collection duration, and provide clinical recommendations (e.g., &lt;14 days = insufficient, 30+ days = reliable for treatment decisions).
        <br><br>
        Keep the interface focused on the core concept: one slider, one chart showing the narrowing confidence band, one key metric (risk score with CI displayed large and clear). Use generous spacing for comfortable reading.
        <br><br>
        The key learning: one night of wearable data is nearly useless due to noise; 30+ nights reveal the true signal as random fluctuations cancel out. This teaches why sufficient sample size is critical for reliable healthcare predictions."
      </div>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('riskChart');
const ctx = canvas.getContext('2d');
const daysSlider = document.getElementById('daysSlider');

canvas.width = canvas.offsetWidth * window.devicePixelRatio;
canvas.height = canvas.offsetHeight * window.devicePixelRatio;
ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
const width = canvas.offsetWidth;
const height = canvas.offsetHeight;

// Generate realistic 90 days of wearable data
const trueRisk = 6.4; // Patient actually has moderate sleep apnea risk
const nightlyData = Array.from({length: 90}, (_, i) => {
  const date = new Date(2024, 0, i + 1);
  const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  
  // Realistic biomarkers with noise
  const hr = 68 + Math.random() * 8 - 4;
  const hrv = 32 + Math.random() * 16 - 8;
  const spo2Drops = 8.5 + Math.random() * 6 - 3; // Indicates apnea events
  const temp = 36.5 + Math.random() * 0.6 - 0.3;
  const movement = 40 + Math.random() * 30;
  const sleepEff = 82 + Math.random() * 12 - 6;
  
  // Weekly pattern (worse on weekends)
  const dayOfWeek = date.getDay();
  const weekendEffect = (dayOfWeek === 0 || dayOfWeek === 6) ? 1.5 : 0;
  
  return {
    date: dateStr,
    hr: hr.toFixed(1),
    hrv: hrv.toFixed(1),
    spo2Drops: (spo2Drops + weekendEffect).toFixed(1),
    temp: temp.toFixed(1),
    movement: movement.toFixed(0),
    sleepEff: sleepEff.toFixed(0),
    riskContribution: (spo2Drops + weekendEffect) * 0.45 + (100 - hrv) * 0.08 + hr * 0.05
  };
});

function calculateCI(days) {
  // Confidence interval shrinks with sqrt(n)
  const baseCI = 3.2;
  const minCI = 0.7;
  return Math.max(minCI, baseCI * Math.sqrt(7 / days));
}

function drawChart(currentDays) {
  ctx.clearRect(0, 0, width, height);
  
  const padding = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotWidth = width - padding.left - padding.right;
  const plotHeight = height - padding.top - padding.bottom;
  
  // Draw grid
  ctx.strokeStyle = '#e9ecef';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (plotHeight / 5) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(padding.left + plotWidth, y);
    ctx.stroke();
  }
  
  // Y-axis labels
  ctx.fillStyle = '#6c757d';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'right';
  [10, 8, 6, 4, 2, 0].forEach((val, i) => {
    const y = padding.top + (plotHeight / 5) * i;
    ctx.fillText(val, padding.left - 10, y + 4);
  });
  
  // Draw confidence band
  const days = Array.from({length: currentDays}, (_, i) => i + 1);
  const ciData = days.map(d => calculateCI(d));
  
  ctx.fillStyle = 'rgba(102, 126, 234, 0.15)';
  ctx.beginPath();
  days.forEach((d, i) => {
    const x = padding.left + (d / 90) * plotWidth;
    const yUpper = padding.top + plotHeight * (1 - (trueRisk + ciData[i]) / 10);
    if (i === 0) ctx.moveTo(x, yUpper);
    else ctx.lineTo(x, yUpper);
  });
  for (let i = days.length - 1; i >= 0; i--) {
    const x = padding.left + (days[i] / 90) * plotWidth;
    const yLower = padding.top + plotHeight * (1 - (trueRisk - ciData[i]) / 10);
    ctx.lineTo(x, yLower);
  }
  ctx.closePath();
  ctx.fill();
  
  // Draw center line (true risk)
  ctx.strokeStyle = '#667eea';
  ctx.lineWidth = 3;
  ctx.beginPath();
  days.forEach((d, i) => {
    const x = padding.left + (d / 90) * plotWidth;
    const y = padding.top + plotHeight * (1 - trueRisk / 10);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Current day marker
  const currentX = padding.left + (currentDays / 90) * plotWidth;
  ctx.strokeStyle = '#495057';
  ctx.lineWidth = 2;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(currentX, padding.top);
  ctx.lineTo(currentX, padding.top + plotHeight);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Axis label
  ctx.fillStyle = '#495057';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Days of Data Collection', padding.left + plotWidth / 2, height - 10);
  
  ctx.save();
  ctx.translate(15, padding.top + plotHeight / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.textAlign = 'center';
  ctx.fillText('Risk Score (0-10)', 0, 0);
  ctx.restore();
}

function updateDashboard() {
  const days = parseInt(daysSlider.value);
  const ci = calculateCI(days);
  
  document.getElementById('currentDay').textContent = days;
  document.getElementById('dataPoints').textContent = days;
  document.getElementById('includedCount').textContent = days;
  
  // Update prediction box
  document.getElementById('riskScore').textContent = trueRisk.toFixed(1);
  document.getElementById('confidenceRange').textContent = 
    `95% CI: ${(trueRisk - ci).toFixed(1)} - ${(trueRisk + ci).toFixed(1)}`;
  document.getElementById('ciWidth').textContent = `¬±${ci.toFixed(1)}`;
  
  // Update reliability
  const reliabilityBadge = document.getElementById('reliabilityBadge');
  const reliabilityText = document.getElementById('reliabilityText');
  const recommendationCard = document.getElementById('recommendationCard');
  const recommendationList = document.getElementById('recommendationList');
  
  if (days < 14) {
    reliabilityBadge.className = 'badge low';
    reliabilityBadge.textContent = 'Low Reliability';
    reliabilityText.innerHTML = '‚ö†Ô∏è High uncertainty - more data needed for reliable prediction';
    recommendationCard.className = 'recommendation-card low';
    recommendationList.innerHTML = `
      <li><strong>Continue wearing device nightly</strong></li>
      <li>Current CI too wide (¬±${ci.toFixed(1)}) for clinical use</li>
      <li>Minimum 14 days needed for moderate confidence</li>
      <li>30+ days recommended for treatment decisions</li>
    `;
  } else if (days < 30) {
    reliabilityBadge.className = 'badge medium';
    reliabilityBadge.textContent = 'Moderate Reliability';
    reliabilityText.innerHTML = 'üìä Moderate confidence - approaching clinical utility';
    recommendationCard.className = 'recommendation-card medium';
    recommendationList.innerHTML = `
      <li>Prediction becoming more stable (CI: ¬±${ci.toFixed(1)})</li>
      <li>Can begin discussing findings with patient</li>
      <li><strong>Recommend 30+ days before treatment decisions</strong></li>
      <li>Consider polysomnography for confirmation</li>
    `;
  } else {
    reliabilityBadge.className = 'badge high';
    reliabilityBadge.textContent = 'High Reliability';
    reliabilityText.innerHTML = '‚úÖ Narrow confidence interval - reliable for clinical use';
    recommendationCard.className = 'recommendation-card high';
    recommendationList.innerHTML = `
      <li><strong>Sufficient data for clinical decision-making</strong></li>
      <li>Risk score: ${trueRisk.toFixed(1)}/10 with CI: ¬±${ci.toFixed(1)}</li>
      <li>Consider referral to sleep specialist</li>
      <li>Discuss CPAP therapy options with patient</li>
      <li>Continue monitoring to track treatment response</li>
    `;
  }
  
  // Calculate averages from collected data
  const collectedData = nightlyData.slice(0, days);
  const avgHR = collectedData.reduce((sum, d) => sum + parseFloat(d.hr), 0) / days;
  const avgHRV = collectedData.reduce((sum, d) => sum + parseFloat(d.hrv), 0) / days;
  const avgSpO2 = collectedData.reduce((sum, d) => sum + parseFloat(d.spo2Drops), 0) / days;
  const avgTemp = collectedData.reduce((sum, d) => sum + parseFloat(d.temp), 0) / days;
  const avgMovement = collectedData.reduce((sum, d) => sum + parseFloat(d.movement), 0) / days;
  const avgEfficiency = collectedData.reduce((sum, d) => sum + parseFloat(d.sleepEff), 0) / days;
  
  document.getElementById('avgHR').textContent = avgHR.toFixed(1);
  document.getElementById('avgHRV').textContent = avgHRV.toFixed(1) + ' ms';
  document.getElementById('avgHRVBio').textContent = avgHRV.toFixed(1) + ' ms';
  document.getElementById('avgSpO2').textContent = avgSpO2.toFixed(1) + '/hr';
  document.getElementById('avgSpO2Bio').textContent = avgSpO2.toFixed(1) + '/hr';
  document.getElementById('avgTemp').textContent = avgTemp.toFixed(1) + '¬∞C';
  document.getElementById('avgMovement').textContent = avgMovement.toFixed(0);
  document.getElementById('avgEfficiency').textContent = avgEfficiency.toFixed(0) + '%';
  
  // Update table
  updateTable(days);
  
  // Redraw chart
  drawChart(days);
}

function updateTable(days) {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = '';
  
  nightlyData.forEach((night, i) => {
    const row = document.createElement('tr');
    row.className = i < days ? 'included' : 'not-included';
    
    // Risk signal classification
    const spo2 = parseFloat(night.spo2Drops);
    let riskClass, riskLabel;
    if (spo2 < 5) {
      riskClass = 'good';
      riskLabel = 'Low';
    } else if (spo2 < 10) {
      riskClass = 'warning';
      riskLabel = 'Moderate';
    } else {
      riskClass = 'bad';
      riskLabel = 'High';
    }
    
    row.innerHTML = `
      <td>${night.date}</td>
      <td>${night.hr}</td>
      <td>${night.hrv}</td>
      <td><span class="value-badge ${riskClass}">${night.spo2Drops}</span></td>
      <td>${night.temp}</td>
      <td>${night.movement}</td>
      <td>${night.sleepEff}%</td>
      <td><span class="value-badge ${riskClass}">${riskLabel}</span></td>
    `;
    
    tbody.appendChild(row);
  });
}

function toggleDeepDive() {
  const content = document.getElementById('deepDiveContent');
  const arrow = document.getElementById('deepDiveArrow');
  content.classList.toggle('visible');
  arrow.classList.toggle('open');
}

function togglePrompt() {
  const content = document.getElementById('promptContent');
  const arrow = document.getElementById('promptArrow');
  content.classList.toggle('visible');
  arrow.classList.toggle('open');
}

daysSlider.addEventListener('input', updateDashboard);
updateDashboard();
</script>

</body>
</html>