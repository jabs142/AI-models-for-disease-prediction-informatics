<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Temporal Drift - Sleep Apnea Detection Model</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f7f8fa;
    color: #2c3e50;
    margin: 0;
    padding: 40px 20px 80px;
    line-height: 1.7;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
  }
  h1 {
    font-size: 1.6em;
    margin-bottom: 0.4em;
    color: #1a1a1a;
    line-height: 1.3;
  }
  .subtitle {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 35px;
    line-height: 1.6;
  }

  .card {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 30px;
  }

  .card-header {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #1a1a1a;
  }

  .section-description {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .badge {
    font-size: 0.7em;
    padding: 6px 14px;
    border-radius: 12px;
    font-weight: 500;
  }
  .badge.deployed { background: #e3f2fd; color: #1976d2; }
  .badge.warning { background: #fff3e0; color: #f57c00; }
  .badge.critical { background: #ffebee; color: #c62828; }

  #performanceChart {
    height: 280px;
    position: relative;
    margin-bottom: 30px;
  }

  #monthControl {
    width: 100%;
    margin: 30px 0;
  }

  .month-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: #666;
    margin-bottom: 15px;
  }

  .accuracy-display {
    text-align: center;
    padding: 25px;
    background: #3498db;
    color: white;
    border-radius: 10px;
    margin: 25px 0;
  }

  .accuracy-value {
    font-size: 3em;
    font-weight: bold;
    margin: 8px 0;
  }

  .accuracy-label {
    font-size: 1em;
    opacity: 0.95;
  }

  .alert-box {
    padding: 20px 24px;
    border-radius: 10px;
    margin-top: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 0.95em;
    line-height: 1.6;
  }
  .alert-box.warning {
    background: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
  }
  .alert-box.critical {
    background: #f8d7da;
    border: 1px solid #dc3545;
    color: #721c24;
  }

  /* Collapsible Section Styling */
  .collapsible-section {
    margin: 50px 0;
  }

  .collapsible-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 15px 20px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.95em;
    font-weight: 600;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  .collapsible-toggle:hover {
    border-color: #3498db;
    color: #3498db;
    background: #f8f9fa;
  }

  .collapsible-arrow {
    font-size: 1.1em;
    transition: transform 0.2s;
    color: #3498db;
  }
  .collapsible-arrow.open {
    transform: rotate(90deg);
  }

  .collapsible-content {
    display: none;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 30px;
    margin-top: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .collapsible-content.visible {
    display: block;
  }

  /* Detailed Analysis Layout */
  .analysis-layout {
    display: grid;
    grid-template-columns: 3fr 1fr;
    gap: 25px;
    margin-bottom: 40px;
  }

  .analysis-panel {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
  }

  .panel-title {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 20px;
    color: #2c3e50;
  }

  #detailedChart {
    height: 280px;
    position: relative;
    margin-bottom: 15px;
  }

  .metrics-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 30px;
  }

  .metric-card {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #dee2e6;
    text-align: center;
  }
  .metric-card.good { border-left-color: #28a745; }
  .metric-card.warning { border-left-color: #ffc107; }
  .metric-card.bad { border-left-color: #dc3545; }

  .metric-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #2c3e50;
  }
  .metric-label {
    font-size: 0.85em;
    color: #6c757d;
    margin-top: 8px;
  }

  .drift-factors {
    margin-top: 30px;
  }
  .drift-factors-header {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 20px;
    color: #2c3e50;
  }
  .factor-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 18px;
    margin: 15px 0;
    background: #f8f9fa;
    border-radius: 10px;
    font-size: 0.95em;
    transition: opacity 0.3s;
  }
  .factor-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4em;
    flex-shrink: 0;
  }

  .recommendations {
    margin-top: 30px;
    padding-top: 25px;
    border-top: 1px solid #e9ecef;
  }
  .recommendations-header {
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 1em;
    color: #2c3e50;
  }

  .patient-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
    margin-top: 20px;
  }
  .patient-table th {
    text-align: left;
    padding: 14px 12px;
    background: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
  }
  .patient-table td {
    padding: 14px 12px;
    border-bottom: 1px solid #e9ecef;
  }
  .patient-table tr:hover {
    background: #f8f9fa;
  }

  .prediction-badge {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85em;
    font-weight: 500;
  }
  .correct { background: #d4edda; color: #155724; }
  .incorrect { background: #f8d7da; color: #721c24; }

  .back-button {
    display: inline-block;
    margin-bottom: 25px;
    padding: 10px 20px;
    background: #3498db;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 500;
    transition: background 0.2s;
  }
  .back-button:hover {
    background: #2980b9;
  }

  .demographics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 25px;
  }

  .demo-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
  }

  .demo-panel h3 {
    font-size: 1em;
    margin: 0 0 15px 0;
    color: #2c3e50;
  }

  .demo-canvas {
    height: 200px;
    position: relative;
  }

  canvas {
    width: 100%;
    height: 100%;
  }

  .deep-dive-content h4 {
    color: #2c3e50;
    margin-top: 30px;
    margin-bottom: 15px;
    font-size: 1.1em;
  }
  .deep-dive-content p {
    margin-bottom: 1.2em;
    color: #495057;
  }
  .deep-dive-content ul {
    padding-left: 25px;
    margin-bottom: 1.2em;
  }
  .deep-dive-content li {
    margin-bottom: 8px;
  }

  .key-takeaway {
    background: #e8f5e9;
    padding: 20px 25px;
    border-left: 5px solid #28a745;
    border-radius: 8px;
    margin-top: 30px;
  }

  .prompt-text {
    color: #495057;
    font-size: 0.95em;
    line-height: 1.8;
  }
</style>
</head>
<body>

<div class="container">
  <a href="index.html" class="back-button">‚Üê Back to Home</a>

  <h1>üî¨ Model Drift: When Patient Populations Change</h1>
  <div class="subtitle">
    <strong>What this teaches:</strong> AI models degrade when patient demographics shift from training data. Watch how changing age distributions and medical conditions reduce accuracy over time.<br>
    <strong>Why it matters:</strong> A model trained on one patient population may fail when demographics change.
  </div>

  <!-- DEMOGRAPHIC SHIFT VISUALIZATION -->
  <div class="card">
    <div class="card-header">
      Why Drift Happens: Patient Population Changes
    </div>
    <div class="section-description">
      The model learned patterns from patients aged 40-55. Now it's encountering older patients (65+) it never trained on. Watch how the age distribution shifts away from the training data‚Äîthis mismatch is why the model fails.
    </div>

    <div class="demographics-grid">
      <div class="demo-panel">
        <h3>Training Population (Jan 2024)</h3>
        <canvas id="trainingDemo" class="demo-canvas"></canvas>
        <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
          Peak: Ages 45-50 | Range: 40-55 years
        </div>
      </div>
      <div class="demo-panel">
        <h3>Current Population (<span id="currentDemoMonth">Jan 2024</span>)</h3>
        <canvas id="currentDemo" class="demo-canvas"></canvas>
        <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
          <span id="distributionStats">Peak: Ages 45-50 | 0% outside training range</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PERFORMANCE BREAKDOWN BY AGE -->
  <div class="card">
    <div class="card-header">
      Model Performance by Patient Age Group
    </div>
    <div class="section-description" style="margin-bottom: 20px;">
      The model maintains high accuracy on the age groups it trained on (40-55) but fails on older patients it never learned about.
    </div>
    <canvas id="performanceByAge" style="height: 180px;"></canvas>
    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
      <div style="display: flex; justify-content: space-around; text-align: center; font-size: 0.9em;">
        <div>
          <div style="font-weight: 600; color: #28a745;">In Training Range</div>
          <div style="font-size: 1.3em; margin-top: 5px;" id="inRangeAccuracy">91%</div>
        </div>
        <div>
          <div style="font-weight: 600; color: #dc3545;">Outside Training Range</div>
          <div style="font-size: 1.3em; margin-top: 5px;" id="outRangeAccuracy">62%</div>
        </div>
        <div>
          <div style="font-weight: 600; color: #495057;">Overall</div>
          <div style="font-size: 1.3em; margin-top: 5px;" id="overallAccuracy">91.2%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PERFORMANCE OVER TIME -->
  <div class="card">
    <div class="card-header">
      Model Performance Over Time
      <span class="badge deployed" id="statusBadge">Deployed</span>
    </div>

    <canvas id="performanceChart"></canvas>

    <div class="month-label">
      <span>Jan 2024</span>
      <span id="currentMonth">Jan 2024</span>
      <span>Dec 2025</span>
    </div>
    <input type="range" id="monthControl" min="0" max="24" step="1" value="0">

    <div class="accuracy-display">
      <div class="accuracy-label">Current Model Accuracy</div>
      <div class="accuracy-value" id="accuracyValue">91.2%</div>
      <div class="accuracy-label" style="font-size: 0.95em; margin-top: 10px;">
        <span id="monthDisplay">Month 0</span> since deployment
      </div>
    </div>

    <div class="alert-box warning" id="alertBox" style="display: none;">
      <span style="font-size: 1.5em;">‚ö†Ô∏è</span>
      <div id="alertText"></div>
    </div>

    <div style="margin-top: 25px; padding: 18px; background: #f8f9fa; border-radius: 8px;">
      <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 12px; color: #2c3e50;">Status:</div>
      <div style="display: flex; gap: 18px; flex-wrap: wrap; font-size: 0.9em;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <span class="badge deployed">Deployed</span>
          <span style="color: #666;">< 3% drop</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span class="badge warning">Monitoring</span>
          <span style="color: #666;">3-8% drop</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span class="badge critical">Action Required</span>
          <span style="color: #666;">> 8% drop</span>
        </div>
      </div>
    </div>
  </div>


  <!-- COLLAPSIBLE: TECHNICAL DEEP DIVE -->
  <div class="collapsible-section">
    <button class="collapsible-toggle" onclick="toggleDeepDive()">
      <span>üìö Technical Deep Dive: Understanding Temporal Drift</span>
      <span class="collapsible-arrow" id="deepDiveArrow">‚Ä∫</span>
    </button>

    <div class="collapsible-content deep-dive-content" id="deepDiveContent">
      <h4>What Is Temporal Drift?</h4>
      <p>
        <strong>Temporal drift</strong> (also called model degradation or concept drift) occurs when the statistical properties of production data differ from training data. Unlike sudden failures, drift is gradual‚Äîaccuracy erodes over weeks or months.
      </p>

      <p>You might be seeing <strong>combined drift</strong> from multiple sources:</p>
      <ul>
        <li><strong>Cohort aging:</strong> Average patient age increases from 48.2 to 50.1 years, changing heart rate and HRV distributions.</li>
        <li><strong>Medication changes:</strong> 12% of patients start CPAP therapy by month 6, fundamentally altering sleep patterns.</li>
        <li><strong>Seasonal patterns:</strong> Winter sleep disruption creates temporary drift the model wasn't exposed to.</li>
        <li><strong>Device updates:</strong> Firmware changes after month 12 subtly shift sensor calibration.</li>
      </ul>

      <h4>How to Detect Drift in Practice</h4>
      <ul>
        <li><strong>Performance Monitoring:</strong> Track accuracy, sensitivity, specificity on held-out test sets. Investigate when metrics drop beyond thresholds.</li>
        <li><strong>Distribution Monitoring:</strong> Use statistical tests (Kolmogorov-Smirnov, Population Stability Index) to detect when input distributions shift.</li>
        <li><strong>Prediction Monitoring:</strong> Watch for changes in prediction distributions that deviate from baseline prevalence.</li>
      </ul>

      <h4>Mitigation Strategies</h4>
      <ul>
        <li><strong>Scheduled Retraining:</strong> Retrain every N months with recent data. This demo suggests retraining when accuracy drops 3-5% (around month 6-12).</li>
        <li><strong>Online Learning:</strong> Continuously update with new labeled data (requires robust feedback loops).</li>
        <li><strong>Drift-Aware Architectures:</strong> Use domain adaptation or models that explicitly account for temporal dynamics.</li>
      </ul>

      <h4>Real-World Example</h4>
      <p>
        COVID-19 diagnostic models trained in March 2020 had <strong>30-40% accuracy drops</strong> by September 2020 due to changing virus strains, testing protocols, and demographics. Without retraining, these models would have been dangerously unreliable.
      </p>

      <div class="key-takeaway">
        <strong>Key Takeaway:</strong> Deployment is not the end‚Äîit's the beginning. Every production ML model needs monitoring and maintenance. For healthcare applications, a model that was 91% accurate could be dangerously unreliable 18 months later without intervention.
      </div>
    </div>
  </div>
</div>

<script>
// Setup canvases
const canvas = document.getElementById('performanceChart');
const ctx = canvas.getContext('2d');
const trainingDemoCanvas = document.getElementById('trainingDemo');
const trainingDemoCtx = trainingDemoCanvas.getContext('2d');
const currentDemoCanvas = document.getElementById('currentDemo');
const currentDemoCtx = currentDemoCanvas.getContext('2d');
const monthControl = document.getElementById('monthControl');

// Setup performance chart canvas
canvas.width = canvas.offsetWidth * window.devicePixelRatio;
canvas.height = canvas.offsetHeight * window.devicePixelRatio;
ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
const width = canvas.offsetWidth;
const height = canvas.offsetHeight;

// Setup demographic canvases
[trainingDemoCanvas, currentDemoCanvas].forEach(c => {
  c.width = c.offsetWidth * window.devicePixelRatio;
  c.height = c.offsetHeight * window.devicePixelRatio;
  c.getContext('2d').scale(window.devicePixelRatio, window.devicePixelRatio);
});

// Performance data with drift
const months = Array.from({length: 25}, (_, i) => i);
const baselineAccuracy = 91.2;
const baselineSensitivity = 88.5;
const baselineSpecificity = 93.1;

const performanceData = months.map(m => {
  const agingEffect = m * 0.15;
  const medicationEffect = m > 6 ? (m - 6) * 0.12 : 0;
  const seasonalVariation = Math.sin(m / 6 * Math.PI) * 1.2;
  const deviceDrift = m > 12 ? (m - 12) * 0.08 : 0;
  const totalDrift = agingEffect + medicationEffect + deviceDrift;

  return {
    month: m,
    accuracy: Math.max(72, baselineAccuracy - totalDrift + seasonalVariation),
    sensitivity: Math.max(68, baselineSensitivity - totalDrift * 1.1 + seasonalVariation * 0.8),
    specificity: Math.max(75, baselineSpecificity - totalDrift * 0.9 + seasonalVariation * 0.5),
    f1: function() {
      const prec = this.sensitivity;
      const rec = this.sensitivity;
      return 2 * (prec * rec) / (prec + rec) / 100;
    }
  };
});

// Generate normal distribution data
function generateNormalDistribution(mean, stdDev, min, max) {
  const data = [];
  for (let age = min; age <= max; age++) {
    const z = (age - mean) / stdDev;
    const value = Math.exp(-0.5 * z * z) / (stdDev * Math.sqrt(2 * Math.PI));
    data.push({ age, value });
  }
  return data;
}

// Generate distribution that shifts over time
function generateDriftedDistribution(month) {
  // Initial distribution (training): centered at 48 with std dev 5
  const trainingMean = 48;
  const trainingStd = 5;

  // As months pass, distribution shifts and widens
  const currentMean = 48 + (month * 0.3); // Shifts older
  const currentStd = 5 + (month * 0.1);   // Widens

  const data = [];

  // Generate main distribution
  for (let age = 20; age <= 80; age++) {
    let value = 0;

    // Primary distribution (shifts and widens)
    const z1 = (age - currentMean) / currentStd;
    value += 0.7 * Math.exp(-0.5 * z1 * z1) / (currentStd * Math.sqrt(2 * Math.PI));

    // Secondary peak emerges at older ages after month 12
    if (month > 12) {
      const secondaryMean = 65 + (month - 12) * 0.2;
      const secondaryStd = 6;
      const z2 = (age - secondaryMean) / secondaryStd;
      const weight = Math.min(0.3, (month - 12) * 0.025); // Grows over time
      value += weight * Math.exp(-0.5 * z2 * z2) / (secondaryStd * Math.sqrt(2 * Math.PI));
    }

    data.push({ age, value });
  }

  return data;
}

// Draw age distribution curve
function drawAgeDistribution(context, canvas, month, isTraining) {
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  context.clearRect(0, 0, w, h);

  const padding = { top: 15, right: 15, bottom: 30, left: 35 };
  const plotWidth = w - padding.left - padding.right;
  const plotHeight = h - padding.top - padding.bottom;

  // Get distribution data
  const data = isTraining
    ? generateNormalDistribution(48, 5, 20, 80)
    : generateDriftedDistribution(month);

  // Find max value for scaling
  const maxValue = Math.max(...data.map(d => d.value));

  // Draw axes
  context.strokeStyle = '#dee2e6';
  context.lineWidth = 1;
  context.beginPath();
  context.moveTo(padding.left, h - padding.bottom);
  context.lineTo(w - padding.right, h - padding.bottom);
  context.stroke();

  // Draw age labels
  context.fillStyle = '#6c757d';
  context.font = '10px sans-serif';
  context.textAlign = 'center';
  for (let age = 20; age <= 80; age += 10) {
    const x = padding.left + ((age - 20) / 60) * plotWidth;
    context.fillText(age, x, h - padding.bottom + 15);
  }

  // Draw training range highlight (40-55 years)
  if (!isTraining) {
    const rangeStart = padding.left + ((40 - 20) / 60) * plotWidth;
    const rangeEnd = padding.left + ((55 - 20) / 60) * plotWidth;
    context.fillStyle = 'rgba(40, 167, 69, 0.1)';
    context.fillRect(rangeStart, padding.top, rangeEnd - rangeStart, plotHeight);

    // Label the training range
    context.fillStyle = '#28a745';
    context.font = '9px sans-serif';
    context.fillText('Training Range', (rangeStart + rangeEnd) / 2, padding.top - 3);
  }

  // Draw distribution curve
  context.strokeStyle = isTraining ? '#3498db' : '#e74c3c';
  context.lineWidth = 2.5;
  context.beginPath();

  data.forEach((point, i) => {
    const x = padding.left + ((point.age - 20) / 60) * plotWidth;
    const y = h - padding.bottom - (point.value / maxValue) * plotHeight;

    if (i === 0) {
      context.moveTo(x, y);
    } else {
      context.lineTo(x, y);
    }
  });

  context.stroke();

  // Fill area under curve
  context.fillStyle = isTraining ? 'rgba(52, 152, 219, 0.2)' : 'rgba(231, 76, 60, 0.2)';
  context.beginPath();

  data.forEach((point, i) => {
    const x = padding.left + ((point.age - 20) / 60) * plotWidth;
    const y = h - padding.bottom - (point.value / maxValue) * plotHeight;

    if (i === 0) {
      context.moveTo(x, h - padding.bottom);
      context.lineTo(x, y);
    } else {
      context.lineTo(x, y);
    }
  });

  context.lineTo(padding.left + ((80 - 20) / 60) * plotWidth, h - padding.bottom);
  context.closePath();
  context.fill();

  // Label axis
  context.fillStyle = '#495057';
  context.font = '11px sans-serif';
  context.textAlign = 'center';
  context.fillText('Patient Age (years)', w / 2, h - 5);
}

// Draw performance breakdown by age group
function drawPerformanceByAge(month) {
  const perfCanvas = document.getElementById('performanceByAge');
  if (!perfCanvas) return;

  const perfCtx = perfCanvas.getContext('2d');
  perfCanvas.width = perfCanvas.offsetWidth * window.devicePixelRatio;
  perfCanvas.height = perfCanvas.offsetHeight * window.devicePixelRatio;
  perfCtx.scale(window.devicePixelRatio, window.devicePixelRatio);

  const w = perfCanvas.offsetWidth;
  const h = perfCanvas.offsetHeight;
  perfCtx.clearRect(0, 0, w, h);

  const padding = { top: 20, right: 30, bottom: 40, left: 50 };
  const plotWidth = w - padding.left - padding.right;
  const plotHeight = h - padding.top - padding.bottom;

  // Age groups and their performance
  const ageGroups = [
    { label: '30-40', accuracy: 89 - month * 0.1, inTraining: true },
    { label: '40-50', accuracy: 91 - month * 0.05, inTraining: true },
    { label: '50-60', accuracy: 87 - month * 0.3, inTraining: true },
    { label: '60-70', accuracy: Math.max(62, 75 - month * 0.8), inTraining: false },
    { label: '70+', accuracy: Math.max(58, 70 - month * 1.0), inTraining: false }
  ];

  const barWidth = plotWidth / ageGroups.length - 10;

  // Draw grid lines
  perfCtx.strokeStyle = '#e9ecef';
  perfCtx.lineWidth = 1;
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (plotHeight / 5) * i;
    perfCtx.beginPath();
    perfCtx.moveTo(padding.left, y);
    perfCtx.lineTo(padding.left + plotWidth, y);
    perfCtx.stroke();
  }

  // Y-axis labels
  perfCtx.fillStyle = '#6c757d';
  perfCtx.font = '11px sans-serif';
  perfCtx.textAlign = 'right';
  [100, 80, 60, 40, 20, 0].forEach((val, i) => {
    const y = padding.top + (plotHeight / 5) * i;
    perfCtx.fillText(val + '%', padding.left - 10, y + 4);
  });

  // Draw bars
  ageGroups.forEach((group, i) => {
    const x = padding.left + i * (barWidth + 10) + 5;
    const barHeight = (group.accuracy / 100) * plotHeight;
    const y = padding.top + plotHeight - barHeight;

    // Bar color based on training status
    perfCtx.fillStyle = group.inTraining ? '#28a745' : '#dc3545';
    perfCtx.fillRect(x, y, barWidth, barHeight);

    // Accuracy value on top of bar
    perfCtx.fillStyle = '#2c3e50';
    perfCtx.font = 'bold 12px sans-serif';
    perfCtx.textAlign = 'center';
    perfCtx.fillText(Math.round(group.accuracy) + '%', x + barWidth / 2, y - 5);

    // Age group label
    perfCtx.fillStyle = '#495057';
    perfCtx.font = '11px sans-serif';
    perfCtx.fillText(group.label, x + barWidth / 2, h - padding.bottom + 15);

    // Training status label
    perfCtx.fillStyle = group.inTraining ? '#28a745' : '#dc3545';
    perfCtx.font = '9px sans-serif';
    perfCtx.fillText(group.inTraining ? 'Trained' : 'Unseen', x + barWidth / 2, h - padding.bottom + 27);
  });

  // Axis labels
  perfCtx.fillStyle = '#495057';
  perfCtx.font = '12px sans-serif';
  perfCtx.textAlign = 'center';
  perfCtx.fillText('Age Group', w / 2, h - 5);

  perfCtx.save();
  perfCtx.translate(12, padding.top + plotHeight / 2);
  perfCtx.rotate(-Math.PI / 2);
  perfCtx.textAlign = 'center';
  perfCtx.fillText('Accuracy (%)', 0, 0);
  perfCtx.restore();
}

// Calculate distribution overlap
function calculateDistributionOverlap(month) {
  const trainingMin = 40;
  const trainingMax = 55;

  // Calculate what percentage of current patients are outside training range
  const currentMean = 48 + (month * 0.3);
  const currentStd = 5 + (month * 0.1);

  // Estimate percentage outside training range using normal distribution
  const lowerZ = (trainingMin - currentMean) / currentStd;
  const upperZ = (trainingMax - currentMean) / currentStd;

  // Approximate cumulative normal distribution
  function normalCDF(z) {
    const t = 1 / (1 + 0.2316419 * Math.abs(z));
    const d = 0.3989423 * Math.exp(-z * z / 2);
    const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return z > 0 ? 1 - p : p;
  }

  const withinRange = normalCDF(upperZ) - normalCDF(lowerZ);
  const outsideRange = (1 - withinRange) * 100;

  return {
    outsideRange: Math.min(100, Math.max(0, outsideRange)),
    currentPeak: Math.round(currentMean)
  };
}

function drawChart(currentMonth) {
  ctx.clearRect(0, 0, width, height);

  const padding = { top: 20, right: 20, bottom: 40, left: 50 };
  const plotWidth = width - padding.left - padding.right;
  const plotHeight = height - padding.top - padding.bottom;

  // Grid
  ctx.strokeStyle = '#e9ecef';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = padding.top + (plotHeight / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(padding.left + plotWidth, y);
    ctx.stroke();
  }

  // Y-axis labels
  ctx.fillStyle = '#6c757d';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'right';
  [95, 90, 85, 80, 75].forEach((val, i) => {
    const y = padding.top + (plotHeight / 4) * i;
    ctx.fillText(val + '%', padding.left - 10, y + 4);
  });

  // Accuracy line
  ctx.strokeStyle = '#3498db';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  performanceData.forEach((d, i) => {
    const x = padding.left + (i / 24) * plotWidth;
    const y = padding.top + plotHeight * (1 - (d.accuracy - 70) / 25);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Current month marker
  const currentX = padding.left + (currentMonth / 24) * plotWidth;
  ctx.strokeStyle = '#495057';
  ctx.lineWidth = 2;
  ctx.setLineDash([3, 3]);
  ctx.beginPath();
  ctx.moveTo(currentX, padding.top);
  ctx.lineTo(currentX, padding.top + plotHeight);
  ctx.stroke();
  ctx.setLineDash([]);

  // Legend
  ctx.font = '12px sans-serif';
  ctx.fillStyle = '#3498db';
  ctx.fillRect(padding.left, height - 25, 15, 3);
  ctx.fillStyle = '#495057';
  ctx.textAlign = 'left';
  ctx.fillText('Model Accuracy', padding.left + 20, height - 20);
}

function updateDashboard() {
  const month = parseInt(monthControl.value);
  const data = performanceData[month];

  const monthNames = ['Jan 2024', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                      'Jan 2025', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec 2025'];
  document.getElementById('currentMonth').textContent = monthNames[month];
  document.getElementById('currentDemoMonth').textContent = monthNames[month];
  document.getElementById('monthDisplay').textContent = `Month ${month}`;

  document.getElementById('accuracyValue').textContent = data.accuracy.toFixed(1) + '%';

  // Update demographic distribution charts
  drawAgeDistribution(trainingDemoCtx, trainingDemoCanvas, month, true);
  drawAgeDistribution(currentDemoCtx, currentDemoCanvas, month, false);

  // Update performance by age group
  drawPerformanceByAge(month);

  // Calculate and display distribution overlap
  const overlap = calculateDistributionOverlap(month);
  document.getElementById('distributionStats').textContent =
    `Peak: Ages ${overlap.currentPeak}-${overlap.currentPeak + 5} | ${overlap.outsideRange.toFixed(0)}% outside training range`;

  // Update accuracy metrics
  const inRangeAccuracy = Math.max(85, 91 - month * 0.15);
  const outRangeAccuracy = Math.max(58, 75 - month * 0.9);
  document.getElementById('inRangeAccuracy').textContent = Math.round(inRangeAccuracy) + '%';
  document.getElementById('outRangeAccuracy').textContent = Math.round(outRangeAccuracy) + '%';
  document.getElementById('overallAccuracy').textContent = data.accuracy.toFixed(1) + '%';

  const accuracyDrop = baselineAccuracy - data.accuracy;

  const statusBadge = document.getElementById('statusBadge');
  const alertBox = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');

  if (accuracyDrop < 3) {
    statusBadge.className = 'badge deployed';
    statusBadge.textContent = 'Deployed';
    alertBox.style.display = 'none';
  } else if (accuracyDrop < 8) {
    statusBadge.className = 'badge warning';
    statusBadge.textContent = 'Monitoring';
    alertBox.className = 'alert-box warning';
    alertBox.style.display = 'flex';
    alertText.innerHTML = `<strong>Performance drift detected:</strong> Accuracy dropped ${accuracyDrop.toFixed(1)}%. Consider retraining with recent data.`;
  } else {
    statusBadge.className = 'badge critical';
    statusBadge.textContent = 'Action Required';
    alertBox.className = 'alert-box critical';
    alertBox.style.display = 'flex';
    alertText.innerHTML = `<strong>Critical drift:</strong> Accuracy dropped ${accuracyDrop.toFixed(1)}%. Model retraining required immediately.`;
  }

  drawChart(month);
}

function toggleDeepDive() {
  const content = document.getElementById('deepDiveContent');
  const arrow = document.getElementById('deepDiveArrow');
  content.classList.toggle('visible');
  arrow.classList.toggle('open');
}

monthControl.addEventListener('input', updateDashboard);
updateDashboard();
</script>

</body>
</html>